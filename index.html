<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sommerfest 2025 - Foto-Galerie</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Foto-Galerie vom Sommerfest 2025 der L√ºbecker Freimaurer">
    <meta name="theme-color" content="#2c5aa0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons f√ºr PWA -->
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 1rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header h1 {
            color: #2c5aa0;
            text-align: center;
            font-size: clamp(1.2rem, 4vw, 2rem);
            font-weight: 700;
            margin: 0;
        }

        .header p {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .logout-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        /* Login Section */
        .login-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e1e5e9;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: #666;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #2c5aa0;
            border-bottom-color: #2c5aa0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c5aa0;
        }

        .form-group input {
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
            display: inline-block;
        }

        .btn-primary {
            background: #2c5aa0;
            color: white;
        }

        .btn-primary:hover {
            background: #1e3c72;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(44, 90, 160, 0.3);
        }

        .btn-secondary {
            background: #28a745;
            color: white;
        }

        .btn-secondary:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        /* Upload Section */
        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: none;
        }

        /* Permission Alert */
        .permission-alert {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 1rem;
            margin: 1.5rem 0;
        }

        .permission-alert h4 {
            color: #856404;
            margin-bottom: 0.5rem;
        }

        .upload-area {
            border: 3px dashed #2c5aa0;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(44, 90, 160, 0.05);
        }

        .upload-area:hover {
            border-color: #1e3c72;
            background: rgba(44, 90, 160, 0.1);
        }

        .upload-area.dragover {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            color: #2c5aa0;
            margin-bottom: 1rem;
        }

        /* Mobile Upload Buttons */
        .mobile-upload-buttons {
            display: none;
            gap: 1rem;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .mobile-upload-buttons {
                display: flex;
                flex-direction: column;
            }
        }

        /* Photo Grid */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .photo-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .photo-card:hover {
            transform: translateY(-5px);
        }

        .photo-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            cursor: pointer;
        }

        .photo-info {
            padding: 1rem;
        }

        .photo-info h4 {
            color: #2c5aa0;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .photo-meta {
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .photo-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2c5aa0;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status Messages */
        .status-message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Hidden Class */
        .hidden {
            display: none !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .photo-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 0.75rem;
            }

            .logout-btn {
                position: static;
                width: 100%;
                margin-top: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>üéâ Sommerfest 2025</h1>
        <p>Foto-Galerie & Upload</p>
        <button id="logoutBtn" class="logout-btn hidden" onclick="logout()">
            üö™ Abmelden
        </button>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Status Messages -->
        <div id="statusMessage" class="status-message hidden"></div>

        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2>üîê Zugang zur Foto-Galerie</h2>
            
            <!-- Tab Navigation -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('teilnehmer')">
                    Teilnehmer
                </button>
                <button class="tab" onclick="switchTab('gaeste')">
                    G√§ste
                </button>
            </div>

            <!-- Teilnehmer Tab -->
            <div id="teilnehmerTab" class="tab-content active">
                <p style="margin-bottom: 1.5rem; color: #666;">
                    Geben Sie Ihre E-Mail-Adresse ein, mit der Sie sich f√ºr das Sommerfest angemeldet haben.
                </p>
                <form id="teilnehmerForm" class="login-form">
                    <div class="form-group">
                        <label for="teilnehmerEmail">E-Mail-Adresse:</label>
                        <input 
                            type="email" 
                            id="teilnehmerEmail" 
                            required 
                            placeholder="ihre.email@beispiel.de"
                            autocomplete="email"
                        >
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <span class="button-text">Als Teilnehmer anmelden</span>
                        <span class="spinner hidden"></span>
                    </button>
                </form>
            </div>

            <!-- G√§ste Tab -->
            <div id="gaesteTab" class="tab-content">
                <p style="margin-bottom: 1.5rem; color: #666;">
                    Geben Sie den Zugangscode ein, den Sie von Ihrem Gastgeber erhalten haben.
                </p>
                <form id="gaesteForm" class="login-form">
                    <div class="form-group">
                        <label for="gaesteName">Ihr Name:</label>
                        <input 
                            type="text" 
                            id="gaesteName" 
                            required 
                            placeholder="Max Mustermann"
                        >
                    </div>
                    <div class="form-group">
                        <label for="gaesteCode">Zugangscode:</label>
                        <input 
                            type="password" 
                            id="gaesteCode" 
                            required 
                            placeholder="Code vom Gastgeber"
                            autocomplete="off"
                        >
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <span class="button-text">Als Gast anmelden</span>
                        <span class="spinner hidden"></span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Main App Section (hidden initially) -->
        <div id="appSection" class="hidden">
            
            <!-- Upload Section -->
            <div class="upload-section">
                <h2>üì∏ Fotos hochladen</h2>
                <p style="margin-bottom: 1rem; color: #666;">
                    Laden Sie Ihre sch√∂nsten Momente vom Sommerfest hoch!
                </p>

                <!-- Permission Alert -->
                <div class="permission-alert">
                    <h4>‚ö†Ô∏è Wichtig: Download-Berechtigung</h4>
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="allowDownload" style="width: 20px; height: 20px;">
                        <span><strong>Ich erlaube anderen Teilnehmern, meine Fotos herunterzuladen</strong></span>
                    </label>
                    <p style="margin-top: 0.5rem; font-size: 0.875rem; color: #666;">
                        Wenn Sie dies nicht aktivieren, k√∂nnen andere Ihre Fotos nur ansehen, aber nicht herunterladen.
                    </p>
                </div>

                <!-- Desktop Upload Area -->
                <div id="uploadArea" class="upload-area">
                    <div class="upload-icon">üì∏</div>
                    <h3>Fotos hier ablegen oder klicken</h3>
                    <p>Mehrere Dateien m√∂glich ‚Ä¢ JPG, PNG, HEIC ‚Ä¢ Max. 10MB pro Datei</p>
                    <input 
                        type="file" 
                        id="fileInput" 
                        accept="image/*" 
                        multiple 
                        style="display: none;"
                    >
                </div>

                <!-- Mobile Upload Buttons -->
                <div class="mobile-upload-buttons">
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                        üì∑ Aus Galerie w√§hlen
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('cameraInput').click()">
                        üì∏ Foto aufnehmen
                    </button>
                    <input 
                        type="file" 
                        id="cameraInput" 
                        accept="image/*" 
                        capture="camera"
                        style="display: none;"
                    >
                </div>

                <!-- Upload Progress -->
                <div id="uploadProgress" class="hidden">
                    <div style="margin: 1rem 0;">
                        <div style="background: #e9ecef; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div id="progressBar" style="background: #28a745; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                        <p id="progressText" style="text-align: center; margin-top: 0.5rem; font-weight: 600;">Lade hoch...</p>
                    </div>
                </div>
            </div>

            <!-- Photo Gallery -->
            <div class="upload-section">
                <h2>üñºÔ∏è Foto-Galerie</h2>
                <p style="margin-bottom: 1.5rem; color: #666;">
                    Alle hochgeladenen Fotos vom Sommerfest 2025
                </p>

                <div id="photoGrid" class="photo-grid">
                    <!-- Photos will be loaded here -->
                </div>

                <div id="loadingGallery" class="hidden" style="text-align: center; padding: 2rem;">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem;">Lade Fotos...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Konfiguration
        const SUPABASE_URL = 'https://database.frankrath.de';
        const SUPABASE_ANON_KEY = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJzdXBhYmFzZSIsImlhdCI6MTc0NzA3MzU4MCwiZXhwIjo0OTAyNzQ3MTgwLCJyb2xlIjoiYW5vbiJ9.0l5w0smQh1FDN-nGnfmNbX80smyL-XcQM9C69OwE3Vo';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // n8n API URLs
        const N8N_BASE_URL = 'https://automatisierung.frankrath.de/webhook';
        
        // Constants
        const GUEST_ACCESS_CODE = 'gaeste2025';
        
        // App State
        let currentUser = null;
        let uploadQueue = [];
        
        // DOM Elements
        const loginSection = document.getElementById('loginSection');
        const appSection = document.getElementById('appSection');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const cameraInput = document.getElementById('cameraInput');
        const photoGrid = document.getElementById('photoGrid');
        const statusMessage = document.getElementById('statusMessage');
        const logoutBtn = document.getElementById('logoutBtn');

        // Initialize App
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Form Event Listeners
        document.getElementById('teilnehmerForm').addEventListener('submit', handleTeilnehmerLogin);
        document.getElementById('gaesteForm').addEventListener('submit', handleGaesteLogin);

        // Upload Event Listeners
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        fileInput.addEventListener('change', handleFileSelect);
        cameraInput.addEventListener('change', handleFileSelect);

        // Initialize App
        async function initializeApp() {
            console.log('üöÄ Foto-System initialisiert');
            
            // Clear old localStorage data to prevent auto-login issues
            const savedUser = localStorage.getItem('sommerfest_foto_user');
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    // Validate saved session is still valid
                    const isValid = await validateSavedSession(user);
                    if (isValid) {
                        currentUser = user;
                        showApp();
                        loadPhotos();
                    } else {
                        // Clear invalid session
                        localStorage.removeItem('sommerfest_foto_user');
                    }
                } catch (error) {
                    // Clear corrupted data
                    localStorage.removeItem('sommerfest_foto_user');
                }
            }
        }

        // Validate saved session
        async function validateSavedSession(user) {
            try {
                // Quick validation - check if user data is complete
                if (!user.email || !user.name) {
                    return false;
                }
                
                // For guests, just check if they have the right structure
                if (user.isGuest && user.userType === 'guest') {
                    return true;
                }
                
                // For participants, verify against the list
                if (user.userType === 'participant') {
                    const response = await fetch(N8N_BASE_URL + '/get-participants');
                    if (!response.ok) return false;
                    
                    const data = await response.json();
                const participants = data.participants || [];
                    return participants.some(p => 
                        p.email.toLowerCase() === user.email.toLowerCase()
                    );
                }
                
                return false;
            } catch (error) {
                console.error('Session validation error:', error);
                return false;
            }
        }

        // Switch Tabs
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if (tab === 'teilnehmer') {
                document.getElementById('teilnehmerTab').classList.add('active');
            } else {
                document.getElementById('gaesteTab').classList.add('active');
            }
        }

        // Handle Teilnehmer Login
        async function handleTeilnehmerLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('teilnehmerEmail').value.trim();
            
            setLoginLoading(e.target, true);
            
            try {
                // Validate against participants list
                const response = await fetch(N8N_BASE_URL + '/get-participants');
                if (!response.ok) {
                    throw new Error('Fehler beim Abrufen der Teilnehmerliste');
                }
                
                const data = await response.json();
                const participants = data.participants || [];
                const participant = (participants || []).find(p => 
                    p.email.toLowerCase() === email.toLowerCase()
                );
                
                if (participant) {
                    currentUser = {
                        email: participant.email,
                        name: participant.name || email.split('@')[0],
                        userType: 'participant',
                        isGuest: false
                    };
                    
                    // Save to localStorage
                    localStorage.setItem('sommerfest_foto_user', JSON.stringify(currentUser));
                    
                    showStatus('Willkommen zur√ºck! üéâ', 'success');
                    showApp();
                    loadPhotos();
                } else {
                    showStatus('Diese E-Mail-Adresse ist nicht in der Teilnehmerliste. Bitte √ºberpr√ºfen Sie Ihre Eingabe.', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showStatus('Verbindungsfehler. Bitte versuchen Sie es sp√§ter erneut.', 'error');
            }
            
            setLoginLoading(e.target, false);
        }

        // Handle G√§ste Login
        async function handleGaesteLogin(e) {
            e.preventDefault();
            
            const name = document.getElementById('gaesteName').value.trim();
            const code = document.getElementById('gaesteCode').value;
            
            setLoginLoading(e.target, true);
            
            if (code === GUEST_ACCESS_CODE) {
                currentUser = {
                    email: 'gast_' + Date.now() + '@sommerfest.de',
                    name: name,
                    userType: 'guest',
                    isGuest: true
                };
                
                // Save to localStorage
                localStorage.setItem('sommerfest_foto_user', JSON.stringify(currentUser));
                
                showStatus('Willkommen als Gast! üéâ', 'success');
                showApp();
                loadPhotos();
            } else {
                showStatus('Ung√ºltiger Zugangscode. Bitte fragen Sie Ihren Gastgeber nach dem richtigen Code.', 'error');
            }
            
            setLoginLoading(e.target, false);
        }

        // Logout
        function logout() {
            if (confirm('M√∂chten Sie sich wirklich abmelden?')) {
                localStorage.removeItem('sommerfest_foto_user');
                currentUser = null;
                loginSection.classList.remove('hidden');
                appSection.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                showStatus('Sie wurden erfolgreich abgemeldet.', 'info');
                
                // Reset forms
                document.getElementById('teilnehmerForm').reset();
                document.getElementById('gaesteForm').reset();
            }
        }

        // Show App Interface
        function showApp() {
            loginSection.classList.add('hidden');
            appSection.classList.remove('hidden');
            logoutBtn.classList.remove('hidden');
            document.querySelector('.upload-section').style.display = 'block';
            
            // Hide camera button on desktop
            if (!isMobileDevice()) {
                const cameraBtn = document.querySelector('.mobile-upload-buttons button:nth-child(2)');
                if (cameraBtn) cameraBtn.style.display = 'none';
            }
        }

        // Check if mobile device
        function isMobileDevice() {
            return /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        }

        // File Upload Handlers
        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            handleFiles(files);
        }

        async function handleFiles(files) {
            const imageFiles = files.filter(file => file.type.startsWith('image/'));
            
            if (imageFiles.length === 0) {
                showStatus('Bitte w√§hlen Sie nur Bilddateien aus.', 'error');
                return;
            }
            
            // Check permission checkbox
            const allowDownload = document.getElementById('allowDownload').checked;
            
            if (!allowDownload) {
                if (!confirm('Sie haben die Download-Berechtigung nicht aktiviert. Ihre Fotos k√∂nnen nur angesehen, aber nicht heruntergeladen werden. Fortfahren?')) {
                    return;
                }
            }
            
            for (let file of imageFiles) {
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    showStatus('Datei ' + file.name + ' ist zu gro√ü (max. 10MB).', 'error');
                    continue;
                }
                
                await uploadFile(file, allowDownload);
            }
        }

        async function uploadFile(file, allowDownload) {
            try {
                document.getElementById('uploadProgress').classList.remove('hidden');
                updateProgress(0, 'Lade "' + file.name + '" hoch...');
                
                // Generate unique filename
                const timestamp = Date.now();
                const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                const fileName = timestamp + '_' + safeName;
                const filePath = 'uploads/' + currentUser.email + '/' + fileName;
                
                // Upload to Supabase Storage
                const { data, error } = await supabase.storage
                    .from('sommerfest-fotos-2025')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });
                
                if (error) {
                    throw error;
                }
                
                updateProgress(50, 'Speichere Metadaten...');
                
                // Save metadata to database (without uploader_type field)
                const { error: dbError } = await supabase
                    .from('fotos_2025')
                    .insert([{
                        uploader_email: currentUser.email,
                        uploader_name: currentUser.name,
                        filename: fileName,
                        original_filename: file.name,
                        file_path: filePath,
                        download_allowed: allowDownload,
                        file_size: file.size,
                        mime_type: file.type
                    }]);
                
                if (dbError) {
                    // If the file was uploaded but DB insert failed, try to delete the file
                    await supabase.storage.from('sommerfest-fotos-2025').remove([filePath]);
                    throw dbError;
                }
                
                updateProgress(100, 'Fertig!');
                showStatus('Foto "' + file.name + '" erfolgreich hochgeladen! üì∏', 'success');
                
                // Reload gallery
                setTimeout(() => {
                    document.getElementById('uploadProgress').classList.add('hidden');
                    loadPhotos();
                }, 1000);
                
            } catch (error) {
                console.error('Upload error:', error);
                document.getElementById('uploadProgress').classList.add('hidden');
                
                // Better error messages
                if (error.message?.includes('Bucket not found')) {
                    showStatus('Speicher nicht konfiguriert. Bitte kontaktieren Sie den Administrator.', 'error');
                } else if (error.message?.includes('row-level security')) {
                    showStatus('Keine Berechtigung zum Upload. Bitte melden Sie sich erneut an.', 'error');
                } else {
                    showStatus('Fehler beim Hochladen: ' + (error.message || 'Unbekannter Fehler'), 'error');
                }
            }
        }

        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // Load Photos from Database
        async function loadPhotos() {
            const loadingElement = document.getElementById('loadingGallery');
            loadingElement.classList.remove('hidden');
            
            try {
                const { data: photos, error } = await supabase
                    .from('fotos_2025')
                    .select('*')
                    .order('uploaded_at', { ascending: false });
                
                if (error) {
                    throw error;
                }
                
                displayPhotos(photos);
                
            } catch (error) {
                console.error('Load photos error:', error);
                if (error.message?.includes('relation "public.fotos_2025" does not exist')) {
                    showStatus('Die Foto-Datenbank wurde noch nicht eingerichtet. Bitte warten Sie auf die Freischaltung.', 'info');
                } else {
                    showStatus('Fehler beim Laden der Fotos: ' + error.message, 'error');
                }
                displayPhotos([]);
            } finally {
                loadingElement.classList.add('hidden');
            }
        }

        // Display Photos in Grid
        function displayPhotos(photos) {
            const grid = document.getElementById('photoGrid');
            
            if (!photos || photos.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #666;"><h3>Noch keine Fotos hochgeladen</h3><p>Seien Sie der Erste und teilen Sie Ihre Momente!</p></div>';
                return;
            }
            
            grid.innerHTML = photos.map(photo => createPhotoCard(photo)).join('');
        }

        // Create Photo Card HTML
        function createPhotoCard(photo) {
            const imageUrl = SUPABASE_URL + '/storage/v1/object/public/sommerfest-fotos-2025/' + photo.file_path;
            const uploadDate = new Date(photo.uploaded_at).toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const downloadButton = photo.download_allowed ? 
                '<button class="btn btn-secondary" style="font-size: 0.875rem; padding: 0.5rem 1rem;" onclick="downloadPhoto(\'' + photo.file_path + '\', \'' + photo.original_filename + '\')">üíæ Download</button>' : 
                '<span style="font-size: 0.75rem; color: #999;">üîí Nur Ansicht</span>';
            
            return '<div class="photo-card"><img src="' + imageUrl + '" alt="' + photo.original_filename + '" class="photo-img" onclick="openLightbox(\'' + imageUrl + '\', \'' + photo.original_filename + '\')" loading="lazy" onerror="this.onerror=null; this.src=\'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect width=%22100%22 height=%22100%22 fill=%22%23ddd%22/><text x=%2250%%22 y=%2250%%22 text-anchor=%22middle%22 dy=%22.3em%22>Fehler</text></svg>\'"><div class="photo-info"><h4>' + photo.original_filename + '</h4><div class="photo-meta">Von: ' + photo.uploader_name + '<br>' + uploadDate + '</div><div class="photo-actions">' + downloadButton + '</div></div></div>';
        }

        // Download Photo
        function downloadPhoto(filePath, originalFilename) {
            const url = SUPABASE_URL + '/storage/v1/object/public/sommerfest-fotos-2025/' + filePath;
            const link = document.createElement('a');
            link.href = url;
            link.download = originalFilename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showStatus('Download gestartet...', 'info');
        }

        // Lightbox functionality
        function openLightbox(imageUrl, title) {
            // Create fullscreen viewer
            const lightbox = document.createElement('div');
            lightbox.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; cursor: pointer;';
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.cssText = 'max-width: 90%; max-height: 90%; object-fit: contain;';
            
            lightbox.appendChild(img);
            lightbox.onclick = () => document.body.removeChild(lightbox);
            document.body.appendChild(lightbox);
        }

        // Utility Functions
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message status-' + type;
            statusMessage.classList.remove('hidden');
            
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 5000);
        }

        function setLoginLoading(form, loading) {
            const button = form.querySelector('button[type="submit"]');
            const text = button.querySelector('.button-text');
            const spinner = button.querySelector('.spinner');
            
            if (loading) {
                button.disabled = true;
                if (text) text.style.display = 'none';
                if (spinner) spinner.classList.remove('hidden');
            } else {
                button.disabled = false;
                if (text) text.style.display = 'inline';
                if (spinner) spinner.classList.add('hidden');
            }
        }

        // Service Worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }
    </script>
</body>
</html>
